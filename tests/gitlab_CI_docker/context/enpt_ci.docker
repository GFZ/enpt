FROM ci_base_ubuntu:0.5

# use bash shell instead of sh shell for all docker commands
SHELL ["/bin/bash", "-c"]

# copy some needed stuff to /root
# NOTE: This fails for non-existing files with docker versions released before 2021.
COPY *.yml /root/
COPY sicor/dist/* /root/
COPY sRTMnet_v120* /root/.isofit/srtmnet/
COPY 6sv-2.1.tar /root/.isofit/sixs/

# update base environment
RUN mamba update -y -n base mamba conda && \
    conda clean -afy

# create ci_env environment
RUN mamba env create -n ci_env -f /root/environment_enpt.yml && \
    conda clean -afy

# force to install latest sicor version which is currently not available from PyPI/conda-forge
RUN source activate ci_env && \
    mamba remove sicor --force && \
    pip install /root/sicor*.whl

# install isofit using the dev branch (uninstall conda-version without touching dependencies)
RUN source activate ci_env && \
    mamba remove isofit --force && \
    pip install git+https://github.com/isofit/isofit.git@dev

# download sRTMnet model and aux files (slow but NASA host server will soon be replaced with Zenodo)
RUN wget -nc -P /root/.isofit/srtmnet https://avng.jpl.nasa.gov/pub/PBrodrick/isofit/sRTMnet_v120.h5
RUN wget -nc -P /root/.isofit/srtmnet https://avng.jpl.nasa.gov/pub/PBrodrick/isofit/sRTMnet_v120_aux.npz
ENV EMULATOR_PATH="/root/.isofit/srtmnet/"

# download and build 6S
RUN wget -nc -P /root/.isofit/sixs https://github.com/ashiklom/isofit/releases/download/6sv-mirror/6sv-2.1.tar &&\
    cd /root/.isofit/sixs &&\
    tar -xf 6sv-2.1.tar &&\
    rm 6sv-2.1.tar &&\
    mamba install gfortran &&\
    sed -i Makefile -e 's/FFLAGS.*/& -std=legacy/' &&\
    make
ENV SIXS_DIR="/root/.isofit/sixs"
