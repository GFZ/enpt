FROM ci_base_centos:0.1

RUN yum update -y && \
    yum install -y texlive make

# copy some needed stuff to /root
COPY *.yml /root/
COPY polymer-v4.13.tar.gz /root/

# update the ci_env environment (that already contains all packages installed via 'docker_pyenvs' repo)
RUN /bin/bash -i -c "\
    source /root/miniconda3/bin/activate ; \
    conda install -c conda-forge mamba ; \
    mamba update -n base -c conda-forge conda;\
    conda activate ci_env; \
    mamba env update -n ci_env -f /root/environment_enpt_polymer.yml"

# install Polymer
RUN /bin/bash -i -c "\
    source /root/miniconda3/bin/activate ; \
    cd /root/ ; \
    tar -zxvf polymer-*.tar.gz ; \
    cd polymer-v4.13 ;\
    make ;\
    pip install -e . ;\
    make auxdata_common ;\
    mkdir -p ANCILLARY/ERA5/ ANCILLARY/METEO/ ;\
    mkdir -p ANCILLARY/ERA5/2017/02/18"

# copy pre-downloaded AUX data to Polymer root to avoid at-runtime downloads
COPY era5_20170218*.nc /root/polymer-v4.13/ANCILLARY/ERA5/2017/02/18