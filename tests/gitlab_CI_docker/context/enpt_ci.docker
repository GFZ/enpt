FROM ci_base_centos:0.2

# copy some needed stuff to /root
COPY *.yml /root/
COPY polymer-v4.13.tar.gz /root/

# update the ci_env environment (that already contains all packages installed via 'docker_pyenvs' repo)
RUN /bin/bash -i -c "\
    source /root/mambaforge/bin/activate ; \
    mamba update -n base -c conda-forge --all;\
    conda activate ci_env; \
    mamba env update -n ci_env -f /root/environment_enpt.yml"

# install Polymer into the ci_env environment
RUN /bin/bash -i -c "\
    source /root/mambaforge/bin/activate ci_env; \
    cd /root/ ; \
    tar -zxvf polymer-*.tar.gz ; \
    cd polymer-v4.13 ;\
    make ;\
    pip install -e . ;\
    make auxdata_common ;\
    mkdir -p ANCILLARY/ERA5/ ANCILLARY/METEO/ ;\
    mkdir -p ANCILLARY/ERA5/2017/02/18"

# copy pre-downloaded AUX data to Polymer root to avoid at-runtime downloads
COPY era5_20170218*.nc /root/polymer-v4.13/ANCILLARY/ERA5/2017/02/18/