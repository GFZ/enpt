before_script:
  - git lfs pull


stages:
    - test
    - deploy


test_enpt:
  stage: test
  script:
    - source /root/miniconda3/bin/activate enpt
    - export GDAL_DATA=/root/miniconda3/envs/enpt/share/gdal
    - export PYTHONPATH=$PYTHONPATH:/root  # /root <- here are the sicor tables

    # update py_tools_ds
    - pip install 'py_tools_ds>=0.14.7'  # FIXME remove as soon as git runner has been rebuilt (included in geoarray)
    - pip install 'geoarray>=0.8.9'  # FIXME remove as soon as git runner has been rebuilt (included in geoarray)
    - pip install lxml
    - pip install numpy-indexed

    # update sicor
    # - conda install -y -q -c conda-forge basemap
    # - rm -rf context/sicor
    # - git clone https://gitext.gfz-potsdam.de/EnMAP/sicor.git ./context/sicor
    # - cd ./context/sicor
    # - make download-tables
    # - python setup.py install
    # - cd ../../

    # run nosetests
    - make nosetests  # test are called here
    # create the docs
    - make docs
  artifacts:
    paths:
    - htmlcov/
    - docs/_build/html/
    - nosetests.html
    - nosetests.xml
    - tests/linting
  when: always


test_styles:
  stage: test
  script:
    - source /root/miniconda3/bin/activate enpt
    - export GDAL_DATA=/root/miniconda3/envs/enpt/share/gdal
    - export PYTHONPATH=$PYTHONPATH:/root  # /root <- directory needed later
    - make lint
  artifacts:
    paths:
    # - tests/data/test_outputs/*.log  # log files are deleted by test teardown method
    - tests/linting/flake8.log
    - tests/linting/pycodestyle.log
    - tests/linting/pydocstyle.log
    when: always


test_enpt_install:
  stage: test
  script:
    - source /root/miniconda3/bin/activate
    - conda create -y -q --name enpt_test python=3
    - source activate enpt_test

    # install some dependencies that cause trouble when installed via pip
    - conda install -y -c conda-forge scipy  # scikit-image, matplotlib

    # install not pip-installable deps of geoarray
    - conda install -y -c conda-forge numpy scikit-image matplotlib pandas gdal rasterio pyproj basemap shapely
    - conda install -y -c conda-forge 'icu=58.*'  # fixes bug for conda-forge gdal build

    # install py_tools_ds
    - pip install 'py_tools_ds>=0.14.7'  # FIXME remove as soon as git runner has been rebuilt (included in geoarray)
    - pip install lxml  # FIXME remove as soon as git runner has been rebuilt
    - pip install numpy-indexed

    # install sicor
    - conda install -y -q -c conda-forge pygrib h5py pytables pyfftw numba llvmlite scikit-learn
    - rm -rf context/sicor
    - git clone https://gitext.gfz-potsdam.de/EnMAP/sicor.git ./context/sicor
    - cd ./context/sicor
    - make install
    - cd ../../

    # install enpt
    - make install
    - cd ..
    - pwd
    - ls

    # test importability
    - python -c "import enpt; print(enpt)"
    - python -c "from enpt.model.images import EnMAPL1Product_SensorGeo"


pages:
  stage: deploy
  dependencies:
    - test_enpt
  script:
    # Create the public directory
    - rm -rf public
    - mkdir public
    - mkdir -p public/doc
    - mkdir -p public/coverage
    - mkdir -p public/nosetests_reports
    # Copy over the docs
    - cp -r docs/_build/html/* public/doc/
    # Copy over the coverage reports
    - cp -r htmlcov/* public/coverage/
    # Copy over the nosetests reports
    - cp nosetests.* public/nosetests_reports/
    # Check if everything is working great
    - ls -al public
    - ls -al public/doc
    - ls -al public/coverage
    - ls -al public/nosetests_reports
  artifacts:
    paths:
      - public
    expire_in: 30 days
  only:
    - master
